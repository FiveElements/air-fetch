<link rel="import" href="../polymer/polymer.html">

<!--
`air-fetch`
Polymer 2 Element for Wrap Fetch API

@demo demo/index.html
-->

<dom-module id="air-fetch">


    <script>
        Polymer({
            is: 'air-fetch',


            properties: {
                debug: {
                    type: Boolean,
                    value: true
                },
                url: {
                    type: String,
                    value: 'air-fetch'
                },
                params: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                },
                notAuto: {
                    type: Boolean,
                    value: false
                },
                method: {
                    type: String,
                    value: 'GET'
                },
                /**
                 * A request has an associated mode, which is "same-origin", "cors", "no-cors", "navigate", or "websocket".
                 * Unless stated otherwise, it is "no-cors".
                 */
                mode: {
                    type: String,
                    value: 'cors'
                },
                /**
                 * A request has an associated cache mode, which is "default", "no-store", "reload", "no-cache", "force-cache", or "only-if-cached".
                 * Unless stated otherwise, it is "default".
                 * <ul>
                 *    <li>"default":  Fetch will inspect the HTTP cache on the way to the network. If there is a fresh response it will be used. If there is a stale response a conditional request will be created, and a normal request otherwise. It then updates the HTTP cache with the response. [HTTP] [HTTP-SEMANTICS] [HTTP-COND] [HTTP-CACHING] [HTTP-AUTH]</li>
                 *    <li>"no-store": Fetch behaves as if there is no HTTP cache at all.</li>
                 *    <li>"reload": Fetch behaves as if there is no HTTP cache on the way to the network. Ergo, it creates a normal request and updates the HTTP cache with the response.</li>
                 *    <li>"no-cache": Fetch creates a conditional request if there is a response in the HTTP cache and a normal request otherwise. It then updates the HTTP cache with the response.</li>
                 *    <li>"force-cache": Fetch uses any response in the HTTP cache matching the request, not paying attention to staleness. If there was no response, it creates a normal request and updates the HTTP cache with the response.</li>
                 *    <li>"only-if-cached": Fetch uses any response in the HTTP cache matching the request, not paying attention to staleness. If there was no response, it returns a network error. (Can only be used when request’s mode is "same-origin". Any cached redirects will be followed assuming request’s redirect mode is "follow" and the redirects do not violate request’s mode.)</li>
                 * </ul>
                 */
                cache: {
                    type: String,
                    value: 'default'
                },

                /**
                 * Fetch Configuration :
                 *
                 * The redirect mode to use: follow, error, or manual. In Chrome the default is follow
                 */
                redirect: {
                    type: String,
                    value: 'follow'
                },
                /**
                 * Fetch Configuration :
                 *
                 * A USVString specifying no-referrer, client, or a URL. The default is client.
                 */
                referrer: {
                    type: String,
                    value: 'client'
                },
                /**
                 *  Fetch Configuration :
                 *
                 *  integrity: Contains the subresource integrity value of the request (e.g., sha256-BpfBw7ivV8q2jLiT13fxDYAe2tJllusRSZ273h2nFSE=). (https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity)
                 */
                integrity: {
                    type: String
                },
                /**
                 *  Fetch Configuration :
                 *
                 * credentials: The request credentials you want to use for the request: omit, same-origin, or include. The default is omit.
                 * In Chrome the default is same-origin before Chrome 47
                 * and include starting with Chrome 47.
                 */
                credentials: {
                    type: String,
                    value: 'omit'
                },
                headers: {
                    type: Array
                },
                response: {
                    type: Object,
                    notify: true
                },
                responseHeaders: {
                    type: Object,
                    notify: true
                }
            },

            // TODO , integrity
            observers: [
                '_fetchObserver(url, params.*, notAuto, method, mode, cache, cache, redirect, referrer, credentials)'
            ],



            // --- Complex Observer
            // --- ---------------------------

            _fetchObserver: function (url, paramChanged, notAuto, method) {
                if (!notAuto) {
                    this._fetch();
                }
            },

            // --- API
            // --- ---------------------------


            // --- Fetch Configuration
            // --- ---------------------------

            _defaultHearders: function () {
                var myHeaders = new Headers({
                    'Content-Type': 'application/json' // "text/plain"
                });
                return myHeaders;
            },

            /**
             * Compute default Fetch option
             * @returns {{method: *, mode: *, headers: *}}
             * @private
             */
            _defaultOptions: function () {
                var myHeaders = this._defaultHearders();
                // https://developer.mozilla.org/en-US/docs/Web/API/Request/Request
                // method: The request method, e.g., GET, POST.
                // credentials: The request credentials you want to use for the request: omit, same-origin, or include. The default is omit.

                var init = {
                    method: this.method,
                    mode: this.mode,
                    cache: this.cache,
                    redirect: this.redirect,
                    referrer: this.referrer,
                    credentials: this.credentials,
                    headers: myHeaders
                };
                if (this.integrity) {
                    init.integrity = this.integrity;
                }
                if (this.debug) console.log('fetch init this.method: ', this.method);
                if (this.debug) console.log('fetch init : ', init);
                return init;
            },

            _fetchIniRequestUrl: function (url, params) {
                if (this.debug) console.log('Construct url :', url, ' --- params :', params);
                return this._requestUrl(url, params);
            },


            // --- Fetch Helper
            // --- ---------------------------
            _fetchRequest: function (opt) {
                if (this.debug) console.log('____________ Fetch opt', opt.init.method, opt.url, ' ____________');
                return window.fetch(opt.url, opt.init);
            },

            _checkResponseStatus: function (response) {
                if (!response.ok) {
                    return response.text().then(function (text) {
                        var error = new Error(response.status + ' (' + response.statusText + ')');
                        error.status = response.status;
                        error.statusText = response.statusText;
                        error.bodyText = text;
                        return Promise.reject(error);
                    });
                }
                return response;
            },


            // --- Fetch Request
            // --- -------------------------------

            /**
             * Fetch configuration for Retrieve request in format
             * ```js
             * {
             *   url: 'String',
             *   init: {},
             *   data: {}
             * }
             * ```
             */
            _fetchInitRequest: function (url, params, data) {
                var self = this;
                var opt = this._defaultOptions(data);
                return new Promise(function (resolve, reject) {
                    var urlGet = self._fetchIniRequestUrl(url, params);
                    resolve({init: opt, url: urlGet});
                }.bind(this));
            },

            // --- Fetch Promise Logic
            // --- ---------------------------
            _fetchPromiseRequest: function (url, params, data) {

                return this._fetchInitRequest(url, params, data)
                        .then(this._fetchRequest.bind(this)) // Do Request
                        .then(this._checkResponseStatus.bind(this))
                        .then(this._transformResponseContentType.bind(this))
                        .then(this._adapterResponseRetrieve.bind(this))
            },

            _fetchPromise: function (url, params, data) {
                return this._fetchPromiseRequest(url, params, data)
                        .then(this._handleResponseRetrieve.bind(this))
                        .then(this._fireFetchResponse.bind(this))
                        .catch(this._fireFetchError.bind(this));
            },

            // --- Fetch Response Parser
            // --- ---------------------------

            _isResponseJson: function (response) {
                var contentType = response.headers.get('content-type');
                return (contentType && contentType.indexOf('application/json') !== -1)
            },

            _transformResponseContentType: function (response) {
                var res = {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url
                };
                // res
//                response.text()
                // TODO test content type
                return response.json().then(function (responseJson) {
//                return Object.assign(res, {response: responseJson});  // NOT IE
                    res.body = responseJson;
                    return res;
                });
            },


            // --- Fetch Adapter
            // --- ---------------------------

            _adapterResponseRetrieve: function (res) {
                return res;
            },



            // --- Response Handler
            // --- ---------------------------

            _handleResponseRetrieve: function (res) {
                this.responseHeaders = res;
                this.response = res.body;
                console.log('_handleResponse : ', res);
                return res;
            },

            // --- Fetch Logic
            // --- ---------------------------


            _fetch: function () {

                return this._fetchPromise(this.url, this.params, this.data);
            },

            // --- Event fetch
            // --- ---------------------------
            /**
             * Fired when a Fetch response is raised.
             *
             * @event air-fetch-response
             */
            _fireFetchResponse: function (response) {
                console.log('air-fetch-response', response);
//                this.fire('air-fetch-response', response);
            },

            /**
             * Fired when a fetch Error in raised.
             *
             * @event air-fetch-error
             */
            _fireFetchError: function (error) {
                console.error('air-fetch-error', error);
                this.fire('air-fetch-error', {error: error});
            },

            // --- Url logic
            // --- ---------------------------
            /**
             * The query string that should be appended to the `url`, serialized from
             * the current value of `params`.
             *
             * @return {string}
             */
            _queryString: function (params) {
                var queryParts = [];
                var param;
                var value;
                var esc = window.encodeURIComponent;
                for (param in params) {
                    value = params[param];
                    param = esc(param);
                    if (Array.isArray(value)) {
                        for (var i = 0; i < value.length; i++) {
                            queryParts.push(param + '=' + esc(value[i]));
                        }
                    } else if (value !== null) {
                        queryParts.push(param + '=' + esc(value));
                    } else {
                        queryParts.push(param);
                    }
                }
                return queryParts.join('&');
            },

            /**
             * The `url` with query string (if `params` are specified).
             *
             * @return {string}
             */
            _requestUrl: function (urlBase, params) {
                var queryString = this._queryString(params);
                var url = urlBase || '';
                if (queryString) {
                    var bindingChar = url.indexOf('?') >= 0 ? '&' : '?';
                    return url + bindingChar + queryString;
                }
                return url;
            },


        });
    </script>
</dom-module>
