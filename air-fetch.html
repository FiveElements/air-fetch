<link rel="import" href="../polymer/polymer.html">

<!--
`air-fetch`
Polymer 2 Element for Wrap Fetch API

@demo demo/index.html
-->

<dom-module id="air-fetch">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <h2>Hello [[url]]</h2>
    </template>

    <script>
        customElements.define('air-fetch', class extends Polymer.Element {
            static get is() {
                return 'air-fetch';
            }

            static get config() {
                return {
                    properties: {
                        url: {
                            type: String,
                            value: 'air-fetch'
                        },
                        params: {
                            type: Object,
                            value: function () {
                                return {};
                            }
                        },
                        notAuto: {
                            type: Boolean,
                            value: false
                        },
                        init: {
                            type: Object,
                            value: function () {
                                return {
                                    method: 'GET',
                                    headers: 'myHeaders',
                                    mode: 'cors',
                                    cache: 'default'
                                };
                            }
                        },
                        method: {
                            type: String,
                            value: 'GET',
                            observer: '_methodChanged'
                        },
                        /**
                         * A request has an associated mode, which is "same-origin", "cors", "no-cors", "navigate", or "websocket".
                         * Unless stated otherwise, it is "no-cors".
                         */
                        mode: {
                            type: String,
                            value: 'cors',
                            observer: '_modeChanged'
                        },
                        /**
                         * A request has an associated cache mode, which is "default", "no-store", "reload", "no-cache", "force-cache", or "only-if-cached".
                         * Unless stated otherwise, it is "default".
                         * <ul>
                         *    <li>"default":  Fetch will inspect the HTTP cache on the way to the network. If there is a fresh response it will be used. If there is a stale response a conditional request will be created, and a normal request otherwise. It then updates the HTTP cache with the response. [HTTP] [HTTP-SEMANTICS] [HTTP-COND] [HTTP-CACHING] [HTTP-AUTH]</li>
                         *    <li>"no-store": Fetch behaves as if there is no HTTP cache at all.</li>
                         *    <li>"reload": Fetch behaves as if there is no HTTP cache on the way to the network. Ergo, it creates a normal request and updates the HTTP cache with the response.</li>
                         *    <li>"no-cache": Fetch creates a conditional request if there is a response in the HTTP cache and a normal request otherwise. It then updates the HTTP cache with the response.</li>
                         *    <li>"force-cache": Fetch uses any response in the HTTP cache matching the request, not paying attention to staleness. If there was no response, it creates a normal request and updates the HTTP cache with the response.</li>
                         *    <li>"only-if-cached": Fetch uses any response in the HTTP cache matching the request, not paying attention to staleness. If there was no response, it returns a network error. (Can only be used when request’s mode is "same-origin". Any cached redirects will be followed assuming request’s redirect mode is "follow" and the redirects do not violate request’s mode.)</li>
                         * </ul>
                         */
                        cache: {
                            type: String,
                            value: 'default',
                            observer: '_cacheChanged'
                        },
                        headers: {
                            type: Array
                        },
                    },

                    observers: [
                        '_fetchObserver(url, init, notAuto)'
                    ],

                };
            };

            // --- Changed Observer
            // --- ---------------------------
            _methodChanged(newValue, oldValue) {
                this.init.method = newValue;
                this.init = this.init;
            };

            _modeChanged(newValue, oldValue) {
                this.init.mode = newValue;
                this.init = this.init;
            };

            _cacheChanged(newValue, oldValue) {
                this.init.cache = newValue;
                this.init = this.init;
            };

            // --- Url logic
            // --- ---------------------------
            _parseParams(params) {
                if (!params) {
                    return '';
                }
                var esc = encodeURIComponent;
                var query = Object.keys(params)
                        .map(k => esc(k) + '=' + esc(params[k]))
                        .join('&');
                return query;
            };

            _parsedUrl(baseUrl, params) {
                var url = baseUrl;
                var qs = this._parsedUrl(params);
                var index = baseUrl.indexOf('?');
                if (index === -1) {
                    url += '?' + qs;
                } else {
                    url += '&' + qs;
                }
                return url;
            };

            // --- Complex Observer
            // --- ---------------------------

            _fetchObserver(url, init, notAuto) {
                if (!notAuto) {
                    this._fetch(url, init);
                }
            };

            // --- API
            // --- ---------------------------

            _fetchPromise(url, init) {
                return fetch(url, params).then(response => {

                });
            };

            _fetch (jwk, data) {
                var self = this;
                return this._encryptPromise(jwk, data).then(function (response) {
                    self.response = response;
                    self._fireFetchResponse(response);
                    return response;
                }).catch(function (err) {
                    self.response = undefined;
                    self._fireFetchError(err);
                });
            },

            // --- Event fetch
            // --- ---------------------------
            /**
             * Fired when a Fetch response is raised.
             *
             * @event air-fetch-response
             */
            _fireFetchResponse(response) {
                console.log('air-fetch-response', response);
                this.fire('air-fetch-response', response);
            };

            /**
             * Fired when a fetch Error in raised.
             *
             * @event air-fetch-error
             */
            _fireFetchError(error) {
                console.error('air-fetch-error', error);
                this.fire('air-fetch-error', {error: error});
            };

        });
    </script>
</dom-module>
